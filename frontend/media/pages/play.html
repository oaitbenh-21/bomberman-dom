<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Multiplayer Game Client</title>
    <link rel="stylesheet" href="../css/play.css">
</head>

<body>
    <h2>WebSocket Game Client</h2>
    <div id="status">Connecting...</div>
    <div id="controls" style="margin: 10px 0;">
        <button onclick="sendMove('Top')">↑</button><br>
        <button onclick="sendMove('Left')">←</button>
        <button onclick="sendMove('Bottom')">↓</button>
        <button onclick="sendMove('Right')">→</button>
    </div>
    <div id="boardContainer"></div>

    <script>
        const socket = new WebSocket('ws://localhost:8080');

        socket.onopen = () => {
            document.getElementById('status').innerText = "✅ Connected to WebSocket server";
        };

        socket.onmessage = (event) => {
            try {
                const data = JSON.parse(event.data);
                console.log(data);
                switch (data.type) {
                    case "join":
                        renderBoard(data.board);
                        const board = document.getElementById('boardContainer');
                        const player = document.createElement('div')
                        player.className = 'player';
                        player.id = data.id;
                        board.appendChild(player);
                        break;
                    case "move":
                        console.log(data);
                        MovePlayer(data.player)
                    default:
                        break;
                }

            } catch (err) {
                console.error('Invalid message:', err);
            }
        };

        socket.onerror = (err) => {
            document.getElementById('status').innerText = "❌ WebSocket error";
            console.error('WebSocket error:', err);
        };

        function sendMove(direction) {
            socket.send(JSON.stringify({ type: 'move', direction }));
        }

        function renderBoard(board) {
            const container = document.getElementById('boardContainer');
            container.innerHTML = ''; // Clear old board
            console.log(container);
            const table = document.createElement('table');
            for (let y = 0; y < board.length; y++) {
                const row = document.createElement('tr');
                for (let x = 0; x < board[y].length; x++) {
                    const cell = document.createElement('td');
                    const val = board[y][x];
                    if (val === 2) {
                        cell.className = 'wall';
                    } else if (val === 1) {
                        cell.className = 'player';
                    } else {
                        cell.className = 'empty';
                    }
                    row.appendChild(cell);
                }
                table.appendChild(row);
            }

            container.appendChild(table);
            console.log(container);
        }
        function MovePlayer(data) {
            /*
            {
                id: "j4f8-g374-gf4i-fd89-3s4g",
                pos: {x:0, y:0},
            }
            */
            const target = document.getElementById(`${data.id}`);
            target.style.transform = `translate(${data.pos.x}px, ${data.pos.y}px)`;
        }
        document.addEventListener("keydown", (e) => {
            document.addEventListener("keydown", (e) => {
                switch (e.key) {
                    case "ArrowDown":
                        sendMove("b")
                        break;
                    case "ArrowUp":
                        sendMove("t")
                        break;
                    case "ArrowLeft":
                        sendMove("l")
                        break;
                    case "ArrowRight":
                        sendMove("r")
                        break;
                    default:
                        break;
                }

            });
        });
    </script>
</body>

</html>