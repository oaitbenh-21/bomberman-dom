<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Multiplayer Game Client</title>
    <link rel="stylesheet" href="../css/play.css">
</head>

<body>
    <div class="popup" id="timer">Please Wait More Players</div>
    <div class="header">
        <div class="contain">
            <div id="count">0/4</div>
            <img class="icon" src="../img/player.png">
        </div>
        <div class="contain">
            <div id="time">00:00</div>
            <img class="icon" src="../img/timer.png">
        </div>
        <div class="contain">
            <div id="lifes">3</div>
            <img class="icon" src="../img/lifes.png">
        </div>
    </div>
    <div id="boardContainer"></div>
    <div id="status"></div>
</body>

<script>
    const socket = new WebSocket('ws://localhost:8080');
    let Counter = 5;
    let TimerID;
    let PlayersCount;
    function ShowBombed(pos, board) {
        const bombed = document.createElement("img");
        bombed.src = "../img/bombed.gif";
        bombed.className = "player";
        bombed.style.top = pos.top + "px";
        bombed.style.left = pos.left + "px";
        board.appendChild(bombed);
        setTimeout(() => {
            bombed.remove()
        }, 400)
    }

    function renderPlayersCount(count) {
        document.getElementById("count").innerHTML = `${count}/4`;
    }

    socket.onmessage = (event) => {
        try {
            const data = JSON.parse(event.data);
            const board = document.getElementById('boardContainer');

            switch (data.type) {
                case "count":
                    renderPlayersCount(data.count);
                    PlayersCount = data.count;
                    break;
                case "board":
                    renderBoard(data.board);
                    break;
                case "join":
                    if (TimerID) clearTimeout(TimerID)
                    Counter = 5;
                    Timer();
                    const player = document.createElement('img');
                    player.className = 'player';
                    player.src = "../img/down-1.png";
                    // player.style.top = data.pos.y + "px";
                    // player.style.left = data.pos.x + "px";
                    player.style.transform = `translate(${data.pos.x}px, ${data.pos.y}px)`;
                    player.id = data.id;
                    board.appendChild(player);
                    break;

                case "move":
                    MovePlayer(data.player);
                    break;

                case "remove":
                    RemoveElement(data.y, data.x);
                    if (data.pos) {
                        ShowBombed(data.pos, board);
                    }
                    break;
                case "kill":
                    document.getElementById(data.id).remove()
                case "bomb":
                    const bomb = document.createElement('img');
                    bomb.className = 'player';
                    bomb.src = "../img/bomb.gif";
                    bomb.style.top = "0px";
                    bomb.style.left = "0px";
                    board.appendChild(bomb);
                    bomb.style.transform = `translate(${data.pos.x}px, ${data.pos.y}px)`;
                    setTimeout(() => {
                        bomb.remove();
                    }, 2000);
                    break;
                default:
                    break;
            }
        } catch (err) { }
    };

    function sendMove(direction) {
        socket.send(JSON.stringify({ type: 'move', direction }));
    }

    function renderBoard(board) {
        const container = document.getElementById('boardContainer');
        container.innerHTML = ''; // Clear old board
        const table = document.createElement('table');
        for (let y = 0; y < board.length; y++) {
            const row = document.createElement('tr');
            for (let x = 0; x < board[y].length; x++) {
                const cell = document.createElement('td');
                const val = board[y][x];
                if (val === 2) {
                    cell.className = 'wall';
                } else if (val === 3) {
                    cell.className = 'box';
                } else {
                    cell.className = 'empty';
                }
                row.appendChild(cell);
            }
            table.appendChild(row);
        }

        container.appendChild(table);
    }
    function Timer() {
        if (PlayersCount <= 1 || Counter == 0) {
            if (Counter == 0) document.getElementById("timer").remove();
            return;
        }
        document.getElementById("timer").innerHTML = `Waiting ${Counter}...`;
        TimerID = setTimeout(() => {
            Counter--;
            Timer()
        }, 1000);
    }
    function MovePlayer(data) {
        const target = document.getElementById(data.id);
        if (target) {
            target.style.transform = `translate(${data.pos.x}px, ${data.pos.y}px)`;
        }
    }

    document.addEventListener("keydown", (e) => {
        switch (e.key) {
            case "ArrowDown":
                sendMove("b");
                break;
            case "ArrowUp":
                sendMove("t");
                break;
            case "ArrowLeft":
                sendMove("l");
                break;
            case "ArrowRight":
                sendMove("r");
                break;
            case " ":
                socket.send(JSON.stringify({
                    type: "bomb",
                }));
                break;
            default:
                break;
        }
    });

    function RemoveElement(y, x) {
        const boardContainer = document.getElementById("boardContainer");
        if (!boardContainer) return;
        const rows = boardContainer.getElementsByTagName("tr");
        if (!rows || rows.length === 0 || y >= rows.length || y < 0) return;
        const colls = rows[y].getElementsByTagName("td");
        if (!colls || colls.length === 0 || x >= colls.length || x < 0) return;
        colls[x].className = "empty";
    }
</script>

</html>